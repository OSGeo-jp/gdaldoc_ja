<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RFC 96: Deferred C++ plugin loading &mdash; GDAL  ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/gdal.css?v=e152ac3b" />

  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="canonical" href="https://gdal.org/development/rfc/rfc96_deferred_plugin_loading.html"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=c033477b"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/translations.js?v=4dbe4bdc"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="このドキュメントについて" href="../../about.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="RFC 97: OGRFeatureDefn, OGRFieldDefn and OGRGeomFieldDefn &#34;sealing&#34;" href="rfc97_feature_and_fielddefn_sealing.html" />
    <link rel="prev" title="RFC 95: Use standard C/C++ integer types (proposed, NOT adopted)" href="rfc95_standard_int_types.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/gdalicon.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../download.html">ダウンロード</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programs/index.html">Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers/raster/index.html">Raster drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers/vector/index.html">Vector drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">ユーザー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../building_from_source.html">Building GDAL from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_environment.html">Setting up a development environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_practices.html">Development practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html">Automated testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_documentation.html">Building documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cmake.html">Using GDAL in CMake projects</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">RFC list</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="rfc1_pmc.html">RFC 1: Project Management Committee Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc2_svn.html">RFC 2: Migration to OSGeo Subversion Repository</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc3_commiters.html">RFC 3: GDAL Committer Guildlines</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc4_geolocate.html">RFC 4: Geolocation Arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc5_unicode.html">RFC 5: Unicode support in GDAL</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc6_sqlgeom.html">RFC 6: Geometry and Feature Style as OGR Special Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc7_vsilapi.html">RFC 7: Use VSILFILE for VSI*L Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc8_devguide.html">RFC 8: Developer Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc9_maintainer.html">RFC 9: GDAL Paid Maintainer Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc10_ogropen.html">RFC 10: OGR Open Parameters (not implemented)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc11_fastidentify.html">RFC 11: Fast Format Identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc12_filemanagement.html">RFC 12: Improved File Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc13_createfeatures.html">RFC 13: Improved Feature Insertion/Update/Delete Performance in Batch Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc14_imagestructure.html">RFC 14: Image Structure Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc15_nodatabitmask.html">RFC 15: Band Masks</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc16_ogr_reentrancy.html">RFC 16: OGR Thread Safety</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc17_python_namespaces.html">RFC 17: Python Namespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc18_ogr_styles_c_api.html">RFC 18: OGR Style Support in C API</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc19_safememalloc.html">RFC 19: Safer memory allocation in GDAL</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc20_srs_axes.html">RFC 20: OGRSpatialReference Axis Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc21_ogrsqlcast.html">RFC 21: OGR SQL type cast and field name alias</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc22_rpc.html">RFC 22: RPC Georeferencing</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc23_ogr_unicode.html">RFC 23.1: Unicode support in OGR</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc24_progressive_data_support.html">RFC 24: GDAL Progressive Data Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc25_fast_open.html">RFC 25: Fast Open (withdrawn)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc26_blockcache.html">RFC 26: GDAL Block Cache Improvements</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc27_supportdata.html">RFC 27: Improved Supporting Data File Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc28_sqlfunc.html">RFC 28: OGR SQL Generalized Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc29_desired_fields.html">RFC 29: OGR Set Ignored Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc30_utf8_filenames.html">RFC 30: Unicode Filenames</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc31_ogr_64.html">RFC 31: OGR 64bit Integer Fields and FIDs</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc32_gdallocationinfo.html">RFC 32: gdallocationinfo utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc33_gtiff_pixelispoint.html">RFC 33: GTiff - Fixing PixelIsPoint Interpretation</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc34_license_policy.html">RFC 34: License Policy Enforcement</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc35_deletereorderalterfielddefn.html">RFC 35: Delete, reorder and alter field definitions of OGR layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc36_open_by_drivername.html">RFC 36: Allow specification of intended driver on GDALOpen (withdrawn)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc37_cplerror_userdata.html">RFC 37: User data callbacks in CPLError</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc38_ogr_faster_open.html">RFC 38: OGR Faster Open (withdrawn)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc39_ogr_layer_algebra.html">RFC 39: OGR Layer Algebra</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc40_enhanced_rat_support.html">RFC 40: Improving performance of Raster Attribute Table implementation for large tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc41_multiple_geometry_fields.html">RFC 41 : Support for multiple geometry fields in OGR</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc42_find_laundered_fields.html">RFC 42: OGR Layer laundered field lookup</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc43_getmetadatadomainlist.html">RFC 43: GDALMajorObject::GetMetadataDomainList</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc44_gdalinfoxml.html">RFC 44: Add Parseable Output Formats for ogrinfo and gdalinfo</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc45_virtualmem.html">RFC 45: GDAL datasets and raster bands as virtual memory mappings</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc46_gdal_ogr_unification.html">RFC 46: GDAL/OGR unification</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc47_dataset_caching.html">RFC 47: Per Dataset Caching and GDALRasterBand Multithreading (not implemented)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc48_geographical_networks_support.html">RFC 48: Geographical networks support</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc49_curve_geometries.html">RFC 49: Curve geometries</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc50_ogr_field_subtype.html">RFC 50: OGR field subtypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc51_rasterio_resampling_progress.html">RFC 51: RasterIO() improvements : resampling and progress callback</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc52_strict_sql_quoting.html">RFC 52: Strict OGR SQL quoting</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc53_ogr_notnull_default.html">RFC 53: OGR not-null constraints and default values</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc54_dataset_transactions.html">RFC 54: Dataset transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc55_refined_setfeature_deletefeature_semantics.html">RFC 55: Refined SetFeature() and DeleteFeature() semantics</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc56_millisecond_precision.html">RFC 56: OFTTime/OFTDateTime millisecond accuracy</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc57_histogram_64bit_count.html">RFC 57: 64-bit bucket counts for histograms</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc58_removing_dataset_nodata_value.html">RFC 58: Removing Dataset Nodata Value</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc59.1_utilities_as_a_library.html">RFC 59.1 : GDAL/OGR utilities as a library</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc59_utilities_as_a_library.html">RFC 59 : GDAL/OGR utilities as a library</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc60_improved_roundtripping_in_ogr.html">RFC 60 : Improved round-tripping in OGR</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc61_support_for_measured_geometries.html">RFC 61 : Support for measured geometries</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc62_raster_algebra.html">RFC 62 : Raster algebra</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc63_sparse_datasets_improvements.html">RFC 63 : Sparse datasets improvements</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc64_triangle_polyhedralsurface_tin.html">RFC 64: Triangle, Polyhedral surface and TIN</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc65_rfc7946_geojson.html">RFC 65: RFC 7946 GeoJSON</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc66_randomlayerreadwrite.html">RFC 66 : OGR random layer read/write capabilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc67_nullfieldvalues.html">RFC 67 : Null values in OGR</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc68_cplusplus11.html">RFC 68: C++11 Compilation Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc69_cplusplus_formatting.html">RFC 69: C/C++ Code Formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc70_output_format_guess.html">RFC 70: Guessing output format from output file name extension for utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc71_github_migration.html">RFC 71: Migration to GitHub</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc72_pytest.html">RFC 72: Update autotest suite to use pytest</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc73_proj6_wkt2_srsbarn.html">RFC 73: Integration of PROJ6 for WKT2, late binding capabilities, time-support and unified CRS database</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc74_sphinx.html">RFC 74: Migrate gdal.org to RTD-style Sphinx infrastructure</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc75_multidimensional_arrays.html">RFC 75: Multidimensional arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc76_ogrpythondrivers.html">RFC 76: OGR Python drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc77_drop_python2_support.html">RFC 77: Drop Python 2 support in favour of Python 3.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc78_gdal_utils_package.html">RFC 78: gdal-utils package</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc79_listing_service_providers.html">RFC 79: Listing of Service Providers on GDAL website</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc80_numfocus_relationship.html">RFC 80: NumFOCUS relationship and sponsorship program</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc81_coordinate_epoch.html">RFC 81: Support for coordinate epochs in geospatial formats</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc83_use_of_project_sponsorship.html">RFC 83: guidelines for the use of GDAL project sponsorship</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc84_cmake.html">RFC 84: Migrating build systems to CMake</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc85_policy_code_additions.html">RFC 85: Policy regarding substantial code additions</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc86_column_oriented_api.html">RFC 86: Column-oriented read API for vector layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc87_signed_int8.html">RFC 87: Signed int8 data type for raster</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc88_googletest.html">RFC 88: Use GoogleTest framework for C/C++ unit tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc89_sql_logging_callback.html">RFC 89: SQL logging callback</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc90_read_compressed_data.html">RFC 90: Direct access to compressed raster data</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc91_dataset_close.html">RFC 91: GDALDataset::Close() method</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc92_wkb_only_geometries.html">RFC 92: WKB Only geometries (on hold)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc93_update_feature.html">RFC 93: OGRLayer::UpdateFeature() method</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc94_field_precision_width_metadata.html">RFC 94: Numeric fields width/precision metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc95_standard_int_types.html">RFC 95: Use standard C/C++ integer types (proposed, <em>NOT</em> adopted)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">RFC 96: Deferred C++ plugin loading</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#context-and-motivation">Context and motivation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#design-constraints">Design constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#details">Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-of-changes-to-do-on-a-simplified-driver">Example of changes to do on a simplified driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#candidate-implementation">Candidate implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#backward-compatibility">Backward compatibility</a></li>
<li class="toctree-l4"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#related-issues-and-prs">Related issues and PRs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adjustments-done-post-gdal-3-9-0-for-gdal-3-9-1">Adjustments done post GDAL 3.9.0, for GDAL 3.9.1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#voting-history">Voting history</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="rfc97_feature_and_fielddefn_sealing.html">RFC 97: OGRFeatureDefn, OGRFieldDefn and OGRGeomFieldDefn &quot;sealing&quot;</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc98_build_requirements_gdal_3_9.html">RFC 98: Build requirements for GDAL 3.9</a></li>
<li class="toctree-l3"><a class="reference internal" href="rfc99_geometry_coordinate_precision.html">RFC 99: Geometry coordinate precision</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../community/index.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sponsors/index.html">Sponsors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">How to contribute?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">ライセンス</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GDAL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html"> GDAL  ドキュメント </a> &raquo;</li>
      
          <li><a href="../index.html">Development</a> &raquo;</li>
      
          <li><a href="index.html">RFC list</a> &raquo;</li>
      
      <li>RFC 96: Deferred C++ plugin loading</li>
    

    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/OSGeo/gdal/edit/master/doc/source/development/rfc/rfc96_deferred_plugin_loading.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="rfc97_feature_and_fielddefn_sealing.html" class="btn btn-neutral float-right" title="RFC 97: OGRFeatureDefn, OGRFieldDefn and OGRGeomFieldDefn &#34;sealing&#34;" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rfc95_standard_int_types.html" class="btn btn-neutral float-left" title="RFC 95: Use standard C/C++ integer types (proposed, NOT adopted)" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rfc-96-deferred-c-plugin-loading">
<span id="rfc-96"></span><h1>RFC 96: Deferred C++ plugin loading<a class="headerlink" href="#rfc-96-deferred-c-plugin-loading" title="Link to this heading"></a></h1>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Author:</p></td>
<td><p>Even Rouault</p></td>
</tr>
<tr class="row-even"><td><p>Contact:</p></td>
<td><p>even.rouault &#64; spatialys.com</p></td>
</tr>
<tr class="row-odd"><td><p>Started:</p></td>
<td><p>2023-Nov-01</p></td>
</tr>
<tr class="row-even"><td><p>Status:</p></td>
<td><p>Adopted, implemented</p></td>
</tr>
<tr class="row-odd"><td><p>Target:</p></td>
<td><p>GDAL 3.9</p></td>
</tr>
</tbody>
</table>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>This RFC adds a mechanism to defer the loading of C++ plugin drivers to
the point where their executable code is actually needed, and converts a number
of relevant drivers to use that mechanism. The aim is to allow for more modular
GDAL builds, while improving the performance of plugin loading.</p>
<p>It mostly targets in-tree plugin drivers, but it also provides a way for
out-of-tree plugin drivers to benefit from deferred loading capabilities,
provided libgdal is built in a specific way</p>
</section>
<section id="context-and-motivation">
<h2>Context and motivation<a class="headerlink" href="#context-and-motivation" title="Link to this heading"></a></h2>
<p>There are currently two ways of loading a GDAL C++ driver:</p>
<ul class="simple">
<li><p>embedded in the core libgdal library. This is the default behavior
for drivers in the official GDAL source repository.</p></li>
<li><p>available in a shared library (.so, .dll, .dylib) in a directory where it
is dynamically loaded when GDALAllRegister() is called. This is what
out-of-tree drivers use, or in-tree drivers if enabling the
[GDAL|OGR]_ENABLE_DRIVER_FOO_PLUGIN=ON or GDAL_ENABLE_PLUGINS=ON
CMake options (cf <a class="reference external" href="https://gdal.org/development/building_from_source.html#build-drivers-as-plugins">https://gdal.org/development/building_from_source.html#build-drivers-as-plugins</a>)
to build them as plugins.</p></li>
</ul>
<p>For packagers/distributors, the second option is convenient for in-tree drivers
that depend on external libraries that are big and/or have a big number of
dependencies (libparquet, etc) and that would substantially increase the size of
the core libgdal library, or which have licenses more restrictive than the MIT
license used by libgdal.</p>
<p>However, there is a penalty at GDALAllRegister() time. For example, on Linux,
it takes ~ 300 ms to complete for a build with 126 plugins, which is a substantial
time for short lived GDAL-based processes (for example a script which would run
gdalinfo or ogrinfo on many files). This time is entirely spent in the dlopen()
method of the operating system and there is, to the best of our knowledge,
nothing we can do to reduce it... besides limiting the amount of dynamic loading
(attempts have been made to load plugins in parallel in multiple threads, but
this does not improve total loading time)
For developers, that plugin loading phase is actually considerably slower, of
the order of ten seconds or more, when debugging GDAL under GDB with many plugin
drivers.</p>
<p>Furthermore, loading drivers that are not needed also involves some
startup/teardown code of external libraries to be run, as well as more virtual
memory to be consumed. Hence this proposal of deferring the actual loading of
the shared library of the plugins until it is really needed.</p>
</section>
<section id="design-constraints">
<h2>Design constraints<a class="headerlink" href="#design-constraints" title="Link to this heading"></a></h2>
<p>We want the new mechanism to be opt-in and fully backwards compatible:</p>
<ul class="simple">
<li><p>to still allow out-of-tree drivers.</p></li>
<li><p>to still allow in-tree drivers, that are compatible of being built as plugins,
to be built in libgdal core, or as plugins depending on the CMake variables.</p></li>
<li><p>to progressively convert existing in-tree drivers to use it.</p></li>
<li><p>to provide the capability to out-of-tree drivers to optionally benefit from
the new capability, provided they build GDAL with the code needed to declared
a plugin proxy driver.</p></li>
</ul>
</section>
<section id="details">
<h2>Details<a class="headerlink" href="#details" title="Link to this heading"></a></h2>
<p>The main idea if that drivers using the new capability will register a proxy
driver (of type GDALPluginDriverProxy, or extending it) with a new
GDALDriverManager::DeclareDeferredPluginDriver() method.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Proxy for a plugin driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Such proxy must be registered with</span>
<span class="cm"> * GDALDriverManager::DeclareDeferredPluginDriver().</span>
<span class="cm"> *</span>
<span class="cm"> * If the real driver defines any of the following metadata items, the</span>
<span class="cm"> * proxy driver should also define them with the same value:</span>
<span class="cm"> * &lt;ul&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DMD_LONGNAME&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DMD_EXTENSIONS&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DMD_EXTENSION&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DMD_OPENOPTIONLIST&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DMD_SUBDATASETS&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DMD_CONNECTION_PREFIX&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_RASTER&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_MULTIDIM_RASTER&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_VECTOR&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_GNM&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_MULTIPLE_VECTOR_LAYERS&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_NONSPATIAL&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_VECTOR_TRANSLATE_FROM&lt;/li&gt;</span>
<span class="cm"> * &lt;/ul&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * The pfnIdentify and pfnGetSubdatasetInfoFunc callbacks, if they are</span>
<span class="cm"> * defined in the real driver, should also be set on the proxy driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Furthermore, the following metadata items must be defined if the real</span>
<span class="cm"> * driver sets the corresponding callback:</span>
<span class="cm"> * &lt;ul&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_OPEN: must be set to YES if the real driver defines pfnOpen&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_CREATE: must be set to YES if the real driver defines pfnCreate&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_CREATE_MULTIDIMENSIONAL: must be set to YES if the real driver defines pfnCreateMultiDimensional&lt;/li&gt;</span>
<span class="cm"> * &lt;li&gt;GDAL_DCAP_CREATECOPY: must be set to YES if the real driver defines pfnCreateCopy&lt;/li&gt;</span>
<span class="cm"> * &lt;/ul&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @since 3.9</span>
<span class="cm"> */</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GDALPluginDriverProxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">GDALDriver</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">GDALPluginDriverProxy</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">osPluginFileName</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The proxy driver uses the metadata items that have been set on it
to declare a minimum set of capabilities (GDAL_DCAP_RASTER, GDAL_DCAP_MULTIDIM_RASTER,
GDAL_DCAP_VECTOR, GDAL_DCAP_OPEN, etc.) to which it can answer directly, and
which are the ones used by GDALOpen() to open a dataset. For other metadata items,
it will fallback to loading the actual driver and forward the requests to it.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Declare a driver that will be loaded as a plugin, when actually needed.</span>
<span class="cm"> *</span>
<span class="cm"> * @param poProxyDriver Plugin driver proxy</span>
<span class="cm"> *</span>
<span class="cm"> * @since 3.9</span>
<span class="cm"> */</span>
<span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">GDALDriverManager::DeclareDeferredPluginDriver</span><span class="p">(</span><span class="n">GDALPluginDriverProxy</span><span class="w"> </span><span class="o">*</span><span class="n">poProxyDriver</span><span class="p">);</span>
</pre></div>
</div>
<p>DeclareDeferredPluginDriver() method will also keep track of the plugin filename to avoid automatically
loading it in the GDALDriverManager::AutoLoadDrivers() method (that method
will only load out-of-tree drivers or in-tree drivers that have not been
converted to use DeclareDeferredPluginDriver()).</p>
<p>The main point is that drivers set the Identify() method on the proxy driver.
That Identify() method must be compiled in libgdal itself, and thus be
defined in a C++ file that does not depend on any external library.
Similarly for the GetSubdatasetInfoFunc() optional method.</p>
<p>When loading the actual driver, the GDALPluginDriverProxy::GetRealDriver()
method will check that all information set in its metadata is
consistent with the actual metadata of the underlying driver, and will warn
when there are differences.</p>
<p>GDALDataset::Open(), Create(), CreateCopy() methods are modified to not use
directly the pfnOpen, pfnCreate, pfnCreateCopy callbacks (that would be the ones
of the proxy driver, and thus nullptr), but to call new GetOpenCallback()/
GetCreateCallback()/GetCreateCopyCallback() methods that the GDALProxyDriver
class overloads to return the function pointers of the real driver, once it
has loaded it.</p>
<p>The DeclareDeferredPluginDriver() method checks if the file of the plugin
exists before registering it. If it is not available, a CPLDebug() message is
emitted. This allows to build a &quot;universal&quot; core libgdal, with plugins that can
be optionally available at runtime.</p>
<p>Cherry-on-the-cake: GDALOpen() will given an explicit error message if it
identifies a dataset to a plugin that is not available at runtime. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gdalinfo test.h5
ERROR 4: `test.h5&#39; not recognized as a supported file format. It could have
been recognized by driver HDF5, but plugin gdal_HDF5.so is not available
in your installation.
</pre></div>
</div>
<p>For each driver supporting deferred plugin loading, GDALAllRegister() must be
modified to call a driver-specific function that calls
GDALDriverManager::DeclareDeferredPluginDriver() (see example in below
paragraph). This code path is enabled only when the driver is built as plugin.</p>
</section>
<section id="example-of-changes-to-do-on-a-simplified-driver">
<span id="rfc96-example-driver"></span><h2>Example of changes to do on a simplified driver<a class="headerlink" href="#example-of-changes-to-do-on-a-simplified-driver" title="Link to this heading"></a></h2>
<p>In the <code class="file docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file of a driver, the new option CORE_SOURCES can be
passed to <code class="docutils literal notranslate"><span class="pre">add_gdal_driver()</span></code> to define source file(s) that must be built in
libgdal, even when the driver is built as a plugin.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add_gdal_driver</span><span class="p">(</span><span class="n">TARGET</span> <span class="n">gdal_FOO</span>
                <span class="n">SOURCES</span> <span class="n">foo</span><span class="o">.</span><span class="n">cpp</span>
                <span class="n">CORE_SOURCES</span> <span class="n">foo_core</span><span class="o">.</span><span class="n">cpp</span>
                <span class="n">PLUGIN_CAPABLE</span>
                <span class="n">STRONG_CXX_WFLAGS</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">TARGET</span> <span class="n">gdal_FOO</span><span class="p">)</span>
    <span class="k">return</span><span class="p">()</span>
<span class="n">endif</span><span class="p">()</span>
<span class="n">gdal_standard_includes</span><span class="p">(</span><span class="n">gdal_FOO</span><span class="p">)</span>
</pre></div>
</div>
<p>A typical <code class="file docutils literal notranslate"><span class="pre">mydrivercore.h`</span></code> header will declare the identify method:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;gdal_priv.h&quot;</span>

<span class="c1">// Used by both DeclareDeferredFOOPlugin() and GDALRegisterFoo()</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">FOO_DRIVER_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;FOO&quot;</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="n">CPL_DLL</span><span class="w"> </span><span class="nf">FOODatasetIdentify</span><span class="p">(</span><span class="n">GDALOpenInfo</span><span class="o">*</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CPL_DLL</span><span class="w"> </span><span class="nf">FOODriverSetCommonMetadata</span><span class="p">(</span><span class="n">GDALDriver</span><span class="w"> </span><span class="o">*</span><span class="n">poDriver</span><span class="p">);</span>
</pre></div>
</div>
<p>And <code class="file docutils literal notranslate"><span class="pre">mydrivercore.cpp</span></code> will contain the implementation of the identify method,
a <code class="docutils literal notranslate"><span class="pre">FOODriverSetCommonMetadata()</span></code> method (with most of the content of the normal
driver registration method, except for function pointers such as pfnOpen, pfnCreate,
pfnCreateCopy or pfnCreateMultiDimensional), as well as a <code class="docutils literal notranslate"><span class="pre">DeclareDeferredXXXPlugin()</span></code>
method that will be called by GDALAllRegister() when the driver is built as a plugin
(the PLUGIN_FILENAME macro is automatically set by the CMake scripts with the filename of the
plugin, e.g. &quot;gdal_FOO.so&quot;):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">FOODatasetIdentify</span><span class="p">(</span><span class="n">GDALOpenInfo</span><span class="o">*</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">nHeaderBytes</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">           </span><span class="n">memcmp</span><span class="p">(</span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pabyHeader</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;FOO&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Called both by DeclareDeferredFOOPlugin() and GDALRegisterFoo()</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">FOODriverSetCommonMetadata</span><span class="p">(</span><span class="n">GDALDriver</span><span class="o">*</span><span class="w"> </span><span class="n">poDriver</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetDescription</span><span class="p">(</span><span class="n">FOO_DRIVER_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DMD_LONGNAME</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The FOO format&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DCAP_RASTER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;YES&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DMD_EXTENSION</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">pfnIdentify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FOODatasetIdentify</span><span class="p">;</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DCAP_OPEN</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;YES&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// since the actual driver defines pfnOpen</span>
<span class="p">}</span>

<span class="cp">#ifdef PLUGIN_FILENAME</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">DeclareDeferredFOOPlugin</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GDALGetDriverByName</span><span class="p">(</span><span class="n">FOO_DRIVER_NAME</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">poDriver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GDALPluginDriverProxy</span><span class="p">(</span><span class="n">PLUGIN_FILENAME</span><span class="p">);</span>
<span class="w">    </span><span class="n">FOODriverSetCommonMetadata</span><span class="p">(</span><span class="n">poDriver</span><span class="p">);</span>
<span class="w">    </span><span class="n">GetGDALDriverManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DeclareDeferredPluginDriver</span><span class="p">(</span><span class="n">poDriver</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>The GDALRegisterFoo() method itself, which is defined in the plugin code,
calls <code class="docutils literal notranslate"><span class="pre">FOODriverSetCommonMetadata</span></code>,
and defines the pfnOpen, pfnCreate, pfnCreateCopy, pfnCreateMultiDimensional
callbacks when they exist:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GDALRegisterFoo</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">GDAL_CHECK_VERSION</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GDALGetDriverByName</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">GDALDriver</span><span class="w"> </span><span class="o">*</span><span class="n">poDriver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GDALDriver</span><span class="p">();</span>
<span class="w">    </span><span class="n">FOODriverSetCommonMetadata</span><span class="p">(</span><span class="n">poDriver</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">pfnOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FOODataset</span><span class="o">::</span><span class="n">Open</span><span class="p">;</span>
<span class="w">    </span><span class="n">GetGDALDriverManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">RegisterDriver</span><span class="p">(</span><span class="n">poDriver</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The modified <code class="file docutils literal notranslate"><span class="pre">gdalallregister.cpp</span></code> file will look like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GDALAllRegister</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">poDriverManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetGDALDriverManager</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Deferred driver declarations must be done *BEFORE* AutoLoadDrivers()</span>
<span class="w">    </span><span class="cp">#if defined(DEFERRED_FOO_DRIVER)</span>
<span class="w">    </span><span class="n">DeclareDeferredFOOPlugin</span><span class="p">();</span>
<span class="w">    </span><span class="cp">#endif</span>

<span class="w">    </span><span class="c1">// This will not load gdal_FOO if above DeclareDeferredFOOPlugin()</span>
<span class="w">    </span><span class="c1">// has been called</span>
<span class="w">    </span><span class="n">poDriverManager</span><span class="o">-&gt;</span><span class="n">AutoLoadDrivers</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Standard driver declarations below for drivers built inside libgdal</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="cp">#if FRMT_foo</span>
<span class="w">    </span><span class="n">GDALRegisterFoo</span><span class="p">();</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="out-of-tree-deferred-loaded-plugins">
<h3>Out-of-tree deferred loaded plugins<a class="headerlink" href="#out-of-tree-deferred-loaded-plugins" title="Link to this heading"></a></h3>
<p>Out-of-tree drivers can also benefit from the deferred loading capability, provided
libgdal is built with CMake variable(s) pointing to external code containing the
code for registering a proxy driver.</p>
<p>This can be done with the following CMake option:</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-arg-ADD_EXTERNAL_DEFERRED_PLUGIN_-driver_name-FILEPATH">
<span class="sig-name descname"><span class="pre">ADD_EXTERNAL_DEFERRED_PLUGIN_&lt;driver_name&gt;:FILEPATH</span></span><span class="sig-prename descclassname"><span class="pre">=/path/to/some/file.cpp</span></span><a class="headerlink" href="#cmdoption-arg-ADD_EXTERNAL_DEFERRED_PLUGIN_-driver_name-FILEPATH" title="Link to this definition"></a></dt>
<dd></dd></dl>

<p>The pointed file must declare a <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">DeclareDeferred&lt;driver_name&gt;(void)</span></code>
method with C linkage that takes care of creating a GDALPluginDriverProxy
instance and calling GDALDriverManager::DeclareDeferredPluginDriver() on it.</p>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading"></a></h2>
<p>One could imagine a further enhancement for out-of-tree plugins where they
would be accompanied by a sidecar text file that would for example declare the
driver capabilities, as well as a limited implementation
of the identify method as a regular expression. But that is out-of-scope of
this RFC.</p>
<p>Changes in the loading of OGR Python drivers (see <a class="reference internal" href="rfc76_ogrpythondrivers.html#rfc-76"><span class="std std-ref">RFC 76: OGR Python drivers</span></a>) are also
out-of-scope of this RFC (they will continue to be loaded at
<a class="reference internal" href="../../api/raster_c_api.html#_CPPv415GDALAllRegisterv" title="GDALAllRegister"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALAllRegister()</span></code></a> time).</p>
</section>
<section id="candidate-implementation">
<h2>Candidate implementation<a class="headerlink" href="#candidate-implementation" title="Link to this heading"></a></h2>
<p>A candidate implementation has been started to implement all the core mechanism,
and convert the Parquet, netCDF and HDF5 drivers. The HDF5 plugin is actually
a good stress test for the deferred loading mechanism, since it incorporates 4
drivers (HDF5, HDF5Image, BAG and S102) in the same shared object. The plan
is to update progressively all in-tree drivers that depend on third-party
libraries (that is the one that are built as plugins when setting the
GDAL_ENABLE_PLUGINS=YES CMake options).</p>
<p>Tests have also been done with QGIS (with the changes at
<a class="reference external" href="https://github.com/qgis/QGIS/pull/55115">https://github.com/qgis/QGIS/pull/55115</a>) to check that the declared set of
metadata items in GDALPluginDriverFeatures is sufficient to avoid loading of the
actual drivers at QGIS startup (they are only loaded when a dataset of the format
handled by the driver is identified)</p>
</section>
<section id="backward-compatibility">
<h2>Backward compatibility<a class="headerlink" href="#backward-compatibility" title="Link to this heading"></a></h2>
<p>Expected to be backward compatible for most practical purposes.</p>
<p>Drivers that would request a driver instance with GDALGetDriverByName() may
now get a GDALPluginDriverProxy instance instead of the &quot;real&quot; driver instance.
This is usually not an issue as few drivers subclass GDALDriver, but that issue
was hit on the PostGISRasterDriver that did subclass it. The solution was to
store the real PostGISRasterDriver instance when it is built in a global variable,
and use that global variable instead of the one returned by GDALGetDriverByName().</p>
<p>Another potential issue is that if external code would directly use the pfnOpen, pfnCreate,
pfnCreateCopy, etc. function pointers of a GDALDriver instance, it would see them
null before the actual driver is loading, but direct access to
those function pointers has never been documented (instead users should use
GDALOpen(), GDALCreate(), GDALCreateCopy() etc), and is not expected to be
done by code external to libgdal core.</p>
<p>However, the candidate implementation hits an issue with the way the GDAL
CondaForge builds work currently. At time of writing, the GDAL CondaForge
build recipee does:</p>
<ul class="simple">
<li><p>a regular GDAL build without Arrow/Parquet dependency (and thus without the
driver), whose libgdal.so goes in to the libgdal package.</p></li>
<li><p>installs libarrow and libparquet</p></li>
<li><p>does an incremental GDAL build with -DOGR_ENABLE_DRIVER_FOO_PLUGIN=ON to
generate ogr_Arrow.so and ogr_Parquet.so. However with the above new mechanism,
this will result in libgdal to be modified to have a DeclareDeferredOGRParquetPlugin
function, as well as including the identification method of the Parquet plugin.
But that modified libgdal.so is discarded currently, and the ogr_Parquet.so
plugin then depends on a identify method that is not implemented.</p></li>
</ul>
<p>The initial idea was that the build recipee would have to be modified to produce
all artifacts (libgdal.so and libparquet.so) at a single time, and dispatch
them appropriately in libgdal and libgdal-arrow-parquet packages, rather than
doing two builds. However, CondaForge builds support several libarrow versions,
and produce thus different Arrow/Parquet plugins, so this approach would not be
practical.</p>
<p>To solve this, the following idea has been implemented. Extract from the updated
<a class="reference internal" href="../building_from_source.html#building-from-source"><span class="std std-ref">Building GDAL from source</span></a> document:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Starting with GDAL 3.9, a number of in-tree drivers, that can be built as
plugins, are loaded in a deferred way. This involves that some part of their
code, which does not depend on external libraries, is included in core libgdal,
whereas most of the driver code is in a separated dynamically loaded library.
For builds where libgdal and its plugins are built in a single operation, this
is fully transparent to the user.

When a plugin driver is known of core libgdal, but not available as a plugin at
runtime, GDAL will inform the user that the plugin is not available, but could
be installed. It is possible to give more hints on how to install a plugin
by setting the following option:

.. option:: GDAL_DRIVER_&lt;driver_name&gt;_PLUGIN_INSTALLATION_MESSAGE:STRING

.. option:: OGR_DRIVER_&lt;driver_name&gt;_PLUGIN_INSTALLATION_MESSAGE:STRING

    Custom message to give a hint to the user how to install a missing plugin


For example, if doing a build with::

    cmake .. -DOGR_DRIVER_PARQUET_PLUGIN_INSTALLATION_MESSAGE=&quot;You may install it with with &#39;conda install -c conda-forge libgdal-arrow-parquet&#39;&quot;

and opening a Parquet file while the plugin is not installed will display the
following error::

    $ ogrinfo poly.parquet
    ERROR 4: `poly.parquet&#39; not recognized as a supported file format. It could have been recognized by driver Parquet, but plugin ogr_Parquet.so is not available in your installation. You may install it with with &#39;conda install -c conda-forge libgdal-arrow-parquet&#39;


For more specific builds where libgdal would be first built, and then plugin
drivers built in later incremental builds, this approach would not work, given
that the core libgdal built initially would lack code needed to declare the
plugin(s).

In that situation, the user building GDAL will need to explicitly declare at
initial libgdal build time that one or several plugin(s) will be later built.
Note that it is safe to distribute such a libgdal library, even if the plugins
are not always available at runtime.

This can be done with the following option:

.. option:: GDAL_REGISTER_DRIVER_&lt;driver_name&gt;_FOR_LATER_PLUGIN:BOOL=ON

.. option:: OGR_REGISTER_DRIVER_&lt;driver_name&gt;_FOR_LATER_PLUGIN:BOOL=ON

    Declares that a driver will be later built as a plugin.

Setting this option to drivers not ready for it will lead to an explicit
CMake error.


For some drivers (ECW, HEIF, JP2KAK, JPEG, JPEGXL, KEA, LERC, MrSID,
MSSQLSpatial, netCDF, OpenJPEG, PDF, TileDB, WEBP), the metadata and/or dataset
identification code embedded on libgdal, will depend on optional capabilities
of the dependent library (e.g. libnetcdf for netCDF)
In that situation, it is desirable that the dependent library is available at
CMake configuration time for the core libgdal built, but disabled with
GDAL_USE_&lt;driver_name&gt;=OFF. It must of course be re-enabled later when the plugin is
built.

For example for netCDF::

    cmake .. -DGDAL_REGISTER_DRIVER_NETCDF_FOR_LATER_PLUGIN=ON -DGDAL_USE_NETCDF=OFF
    cmake --build .

    cmake .. -DGDAL_USE_NETCDF=ON -DGDAL_ENABLE_DRIVER_NETCDF=ON -DGDAL_ENABLE_DRIVER_NETCDF_PLUGIN=ON
    cmake --build . --target gdal_netCDF


For other drivers, GDAL_REGISTER_DRIVER_&lt;driver_name&gt;_FOR_LATER_PLUGIN /
OGR_REGISTER_DRIVER_&lt;driver_name&gt;_FOR_LATER_PLUGIN can be declared at
libgdal build time without requiring the dependent libraries needed to build
the plugin later to be available.
</pre></div>
</div>
</section>
<section id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="../../tutorials/raster_driver_tut.html#raster-driver-tut"><span class="std std-ref">Raster driver implementation tutorial</span></a> and <a class="reference internal" href="../../tutorials/vector_driver_tut.html#vector-driver-tut"><span class="std std-ref">Vector driver implementation tutorial</span></a> will be updated to point
to this RFC.
<a class="reference internal" href="../building_from_source.html#building-from-source"><span class="std std-ref">Building GDAL from source</span></a> will receive the new paragraph mentioned above.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Link to this heading"></a></h2>
<p>A C++ test will be added testing that for one of the updated drivers, the
plugin is loaded in a deferred way in situations where this is expected, and
is not loaded in other situations.</p>
</section>
<section id="related-issues-and-prs">
<h2>Related issues and PRs<a class="headerlink" href="#related-issues-and-prs" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/OSGeo/gdal/pull/8695">https://github.com/OSGeo/gdal/pull/8695</a>: candidate implementation</p></li>
</ul>
</section>
<section id="adjustments-done-post-gdal-3-9-0-for-gdal-3-9-1">
<h2>Adjustments done post GDAL 3.9.0, for GDAL 3.9.1<a class="headerlink" href="#adjustments-done-post-gdal-3-9-0-for-gdal-3-9-1" title="Link to this heading"></a></h2>
<p>After GDAL 3.9.0 release, it has been noticed that the following setup which
used to work in prior releases no longer worked:</p>
<ul class="simple">
<li><p>Step 1: building libgdal without support for driver X</p></li>
<li><dl class="simple">
<dt>Step 2: building driver X as a plugin, discarding the libgdal share library,</dt><dd><p>built at that stage</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Step 3: using driver X built as a plugin against libgdal built at step 1. In that</dt><dd><p>scenario, driver X is expected to be loaded as if it was an out-of-tree drivers.</p>
</dd>
</dl>
</li>
</ul>
<p>Such scenario is used when delivering a fully open-source libgdal without any
prior knowledge of which drivers could be later built as plugins, or for which
pre-configuring libgdal to support such drivers is not practical because they
rely on a proprietary SDK and the identification method and/or driver metadata
depends on the availability of the SDK include files (e.g. MrSID).</p>
<p>Starting with GDAL 3.9.1, the <code class="docutils literal notranslate"><span class="pre">add_gdal_driver()</span></code> function in the CMakeLists.txt
of drivers which use the <code class="docutils literal notranslate"><span class="pre">CORE_SOURCES</span></code> keyword must also declare the
<code class="docutils literal notranslate"><span class="pre">NO_SHARED_SYMBOL_WITH_CORE</span></code> keyword, so that the files pointed by CORE_SOURCES
are built twice: once in libgdal with a <code class="docutils literal notranslate"><span class="pre">GDAL_core_</span></code> prefix, and another time
in the plugin itself with a <code class="docutils literal notranslate"><span class="pre">GDAL_driver_</span></code> prefix, by using the
PLUGIN_SYMBOL_NAME() macro of <code class="file docutils literal notranslate"><span class="pre">gdal_priv.h</span></code>.</p>
<p>Example in ogr/ogrsf_frmsts/oci/CMakeLists.txt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>add_gdal_driver(TARGET ogr_OCI
                SOURCES ${SOURCE}
                CORE_SOURCES ogrocidrivercore.cpp
                PLUGIN_CAPABLE
                NO_SHARED_SYMBOL_WITH_CORE)
</pre></div>
</div>
<p>Example in ogrocidrivercore.h:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define OGROCIDriverIdentify \</span>
<span class="cp">   PLUGIN_SYMBOL_NAME(OGROCIDriverIdentify)</span>
<span class="cp">#define OGROCIDriverSetCommonMetadata \</span>
<span class="cp">   PLUGIN_SYMBOL_NAME(OGROCIDriverSetCommonMetadata)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">OGROCIDriverIdentify</span><span class="p">(</span><span class="n">GDALOpenInfo</span><span class="w"> </span><span class="o">*</span><span class="n">poOpenInfo</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">OGROCIDriverSetCommonMetadata</span><span class="p">(</span><span class="n">GDALDriver</span><span class="w"> </span><span class="o">*</span><span class="n">poDriver</span><span class="p">);</span>
</pre></div>
</div>
<p>A consequence of that change is that drivers built as a plugin against GDAL 3.9.0
will not be loadable by GDAL 3.9.1 (or later patch in the 3.9 series), because
they relied on driver-specific functions that are no longer exported by libgdal &gt;= 3.9.1.</p>
<p>After that, things should work as they used to, and drivers built against libgdal 3.9.1
should work against libgdal 3.9.2 for example.</p>
<p>Also note that the above only affects <em>in-tree</em> plugin drivers. Out-of-tree plugin drivers
are not affected.</p>
</section>
<section id="voting-history">
<h2>Voting history<a class="headerlink" href="#voting-history" title="Link to this heading"></a></h2>
<p>+1 from PSC members KurtS, HowardB, JukkaR, JavierJS and EvenR</p>
</section>
</section>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rfc97_feature_and_fielddefn_sealing.html" class="btn btn-neutral float-right" title="RFC 97: OGRFeatureDefn, OGRFieldDefn and OGRGeomFieldDefn &#34;sealing&#34;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rfc95_standard_int_types.html" class="btn btn-neutral float-left" title="RFC 95: Use standard C/C++ integer types (proposed, NOT adopted)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <div class="info">
      <a class="logo-link" href="https://osgeo.org">
        <div class="osgeo-logo"></div>
      </a>
      <div class="copyright">
      

      &copy; 1998-2024 <a href="https://github.com/warmerdam">Frank Warmerdam</a>,
      <a href="https://github.com/rouault">Even Rouault</a>, and
      <a href="https://github.com/OSGeo/gdal/graphs/contributors">others</a>


      
      </div>
    </div>
  </div>
</footer>
        </div>
      </div>
    </section>
  </div>
  
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>