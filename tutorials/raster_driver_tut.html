<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ラスタードライバー実装チュートリアル &mdash; GDAL  ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../_static/css/gdal.css?v=e152ac3b" />

  
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="canonical" href="https://gdal.org/tutorials/raster_driver_tut.html"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=c033477b"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/translations.js?v=91613774"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="GDAL Warp API tutorial (Reprojection, ...)" href="warp_tut.html" />
    <link rel="prev" title="ラスターAPIチュートリアル" href="raster_api_tut.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../index.html">
            
              <img src="../_static/gdalicon.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../download.html">ダウンロード</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/index.html">プログラム</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers/raster/index.html">ラスタードライバー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers/vector/index.html">ベクタードライバー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">ユーザー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">チュートリアル</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#raster">ラスター</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="raster_api_tut.html">ラスターAPIチュートリアル</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ラスタードライバー実装チュートリアル</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overall-approach">全体的なアプローチ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementing-the-dataset">データセットの実装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementing-the-rasterband">ラスターバンドの実装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-driver">ドライバー</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-driver-to-gdal-tree">ドライバーを GDAL ツリーに追加</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-georeferencing">ジオリファレンシングの追加</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overviews">オーバービュー</a></li>
<li class="toctree-l4"><a class="reference internal" href="#file-creation">ファイルの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rawdataset-rawrasterband-helper-classes">RawDataset/RawRasterBand ヘルパークラス</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metadata-and-other-exotic-extensions">メタデータおよびその他のエキゾチックな拡張</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="warp_tut.html">GDAL Warp API tutorial (Reprojection, ...)</a></li>
<li class="toctree-l3"><a class="reference internal" href="gdal_grid_tut.html">GDAL Grid Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="geotransforms_tut.html">Geotransform Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#multidimensional-raster">多次元ラスター</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vector">ベクター</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#geographic-network-model">ジオグラフィックネットワークモデル</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#projections-and-spatial-reference-systems-tutorial-osr-ogrspatialreference">投影と空間参照システムチュートリアル (OSR - OGRSpatialReference)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">開発</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">コミュニティ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sponsors/index.html">スポンサー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">どのように貢献できますか?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">ライセンス</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GDAL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html"> GDAL  ドキュメント </a> &raquo;</li>
      
          <li><a href="index.html">チュートリアル</a> &raquo;</li>
      
      <li>ラスタードライバー実装チュートリアル</li>
    

    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/OSGeo/gdal/edit/master/doc/source/tutorials/raster_driver_tut.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="warp_tut.html" class="btn btn-neutral float-right" title="GDAL Warp API tutorial (Reprojection, ...)" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="raster_api_tut.html" class="btn btn-neutral float-left" title="ラスターAPIチュートリアル" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="raster-driver-implementation-tutorial">
<span id="raster-driver-tut"></span><h1>ラスタードライバー実装チュートリアル<a class="headerlink" href="#raster-driver-implementation-tutorial" title="Link to this heading"></a></h1>
<section id="overall-approach">
<h2>全体的なアプローチ<a class="headerlink" href="#overall-approach" title="Link to this heading"></a></h2>
<p>一般的に、新しいフォーマットは, <a class="reference internal" href="../api/gdaldataset_cpp.html#_CPPv411GDALDataset" title="GDALDataset"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GDALDataset</span></code></a> のサブクラスとしてフォーマット固有のドライバーを実装し,バンドアクセサは <a class="reference internal" href="../api/gdalrasterband_cpp.html#_CPPv414GDALRasterBand" title="GDALRasterBand"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GDALRasterBand</span></code></a> のサブクラスとして実装します.また,フォーマット用の <a class="reference internal" href="../api/gdaldriver_cpp.html#_CPPv410GDALDriver" title="GDALDriver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GDALDriver</span></code></a> インスタンスを作成し, <a class="reference internal" href="../api/gdaldriver_cpp.html#_CPPv417GDALDriverManager" title="GDALDriverManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GDALDriverManager</span></code></a> に登録して,システムがフォーマットを認識できるようにします.</p>
<p>このチュートリアルでは,シンプルな読み取り専用ドライバー( JDEM ドライバーをベースにしたもの)の実装から始め,RawRasterBand ヘルパークラスの利用,作成可能および更新可能なフォーマットの実装,およびいくつかの難解な問題に進みます.</p>
<p>GDAL ドライバーの実装を試みる前に, <a class="reference internal" href="../user/raster_data_model.html#raster-data-model"><span class="std std-ref">ラスターデータモデル</span></a> を確認し理解することを強くお勧めします.</p>
</section>
<section id="implementing-the-dataset">
<h2>データセットの実装<a class="headerlink" href="#implementing-the-dataset" title="Link to this heading"></a></h2>
<p>日本の DEM フォーマット用の読み取り専用ドライバーの最小限の実装を示します(<a class="reference external" href="https://github.com/OSGeo/gdal/blob/master/frmts/jdem/jdemdataset.cpp">jdemdataset.cpp</a>). まず,この場合のフォーマット固有のデータセットクラス JDEMDataset を宣言します.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JDEMDataset</span><span class="w"> </span><span class="k">final</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">GDALPamDataset</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">JDEMRasterBand</span><span class="p">;</span>

<span class="w">    </span><span class="n">VSILFILE</span><span class="w">           </span><span class="o">*</span><span class="n">m_fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">GByte</span><span class="w">               </span><span class="n">m_abyHeader</span><span class="p">[</span><span class="n">HEADER_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="n">OGRSpatialReference</span><span class="w"> </span><span class="n">m_oSRS</span><span class="p">{};</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span>
<span class="w">                     </span><span class="n">JDEMDataset</span><span class="p">();</span>
<span class="w">                    </span><span class="o">~</span><span class="n">JDEMDataset</span><span class="p">();</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">GDALDataset</span><span class="w"> </span><span class="o">*</span><span class="nf">Open</span><span class="p">(</span><span class="w"> </span><span class="n">GDALOpenInfo</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">Identify</span><span class="p">(</span><span class="w"> </span><span class="n">GDALOpenInfo</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="n">CPLErr</span><span class="w"> </span><span class="nf">GetGeoTransform</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padfTransform</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">OGRSpatialReference</span><span class="o">*</span><span class="w"> </span><span class="nf">GetSpatialRef</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>一般的に,ドライバーの機能を提供するためには, GDALDataset 基底クラスのさまざまな仮想メソッドをオーバーライドします. ただし,Open() メソッドは特別です. これは基底クラスの仮想メソッドではなく,この操作のために独立した関数が必要なので,static として宣言します. JDEMDataset クラスのメソッドとして実装するのは便利ですデータベースオブジェクトの内容を変更する特権的なアクセスがあるためです.</p>
<p>Open メソッド自体は次のようになります:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">GDALDataset</span><span class="w"> </span><span class="o">*</span><span class="nf">JDEMDataset::Open</span><span class="p">(</span><span class="w"> </span><span class="n">GDALOpenInfo</span><span class="w"> </span><span class="o">*</span><span class="n">poOpenInfo</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Confirm that the header is compatible with a JDEM dataset.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Identify</span><span class="p">(</span><span class="n">poOpenInfo</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Confirm the requested access is supported.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">eAccess</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GA_Update</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_NotSupported</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;The JDEM driver does not support update access to existing &quot;</span>
<span class="w">                 </span><span class="s">&quot;datasets.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check that the file pointer from GDALOpenInfo* is available.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">fpL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Create a corresponding GDALDataset.</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">poDS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpl</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">JDEMDataset</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Borrow the file pointer from GDALOpenInfo*.</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">m_fp</span><span class="p">,</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">fpL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Store the header (we have already checked it is at least HEADER_SIZE</span>
<span class="w">    </span><span class="c1">// byte large).</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">m_abyHeader</span><span class="p">,</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pabyHeader</span><span class="p">,</span><span class="w"> </span><span class="n">HEADER_SIZE</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">psHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">m_abyHeader</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetField</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetField</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">GDALCheckDatasetDimensions</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterXSize</span><span class="p">,</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterYSize</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Create band information objects.</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetBand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JDEMRasterBand</span><span class="p">(</span><span class="n">poDS</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Initialize any PAM information.</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetDescription</span><span class="p">(</span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pszFilename</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">TryLoadXML</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Check for overviews.</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">oOvManager</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">poDS</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pszFilename</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">poDS</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>データベースの Open 関数の最初のステップは,渡されたファイルが実際にこのドライバーのタイプであることを確認することです. 重要なのは,各ドライバーの Open 関数が順番に呼び出されることで,成功するまで呼び出されます. ドライバーは,渡されたファイルがそのフォーマットでない場合は静かに nullptr を返す必要があります. ファイルを開くための情報は, GDALOpenInfo オブジェクトに含まれています. GDALOpenInfo には次のパブリックデータメンバが含まれています:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w">        </span><span class="o">*</span><span class="n">pszFilename</span><span class="p">;</span>
<span class="kt">char</span><span class="o">**</span><span class="w">      </span><span class="n">papszOpenOptions</span><span class="p">;</span>
<span class="n">GDALAccess</span><span class="w">  </span><span class="n">eAccess</span><span class="p">;</span><span class="w">  </span><span class="c1">// GA_ReadOnly or GA_Update</span>
<span class="kt">int</span><span class="w">         </span><span class="n">nOpenFlags</span><span class="p">;</span>
<span class="kt">int</span><span class="w">         </span><span class="n">bStatOK</span><span class="p">;</span>
<span class="kt">int</span><span class="w">         </span><span class="n">bIsDirectory</span><span class="p">;</span>
<span class="n">VSILFILE</span><span class="w">   </span><span class="o">*</span><span class="n">fpL</span><span class="p">;</span>
<span class="kt">int</span><span class="w">         </span><span class="n">nHeaderBytes</span><span class="p">;</span>
<span class="n">GByte</span><span class="w">       </span><span class="o">*</span><span class="n">pabyHeader</span><span class="p">;</span>
</pre></div>
</div>
<p>ドライバーは,これらを検査してファイルがサポートされているかどうかを確立できます.`pszFilename` がファイルシステムのオブジェクトを参照している場合,`bStatOK` フラグがTRUE に設定されます. また,ファイルが正常に開かれた場合,最初のキロバイト程度が読み込まれ,pabyHeader に格納され,その正確なサイズが <cite>nHeaderBytes</cite> に格納されます.</p>
<p>この典型的なテスト例では,ファイルが正常に開かれたこと,テストを実行するのに十分なヘッダ情報があること,およびヘッダのさまざまな部分がこのフォーマットに期待される値であることを確認します. この場合,JDEM フォーマットにはマジックナンバーがないため,合理的な世紀値を持つことを確認するためにさまざまな日付フィールドをチェックします.テストに失敗した場合,このファイルがサポートされていないことを示す NULL を静かに返します.</p>
<p>識別は実際には Identify() 静的関数に委任されます:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/************************************************************************/</span>
<span class="cm">/*                              Identify()                              */</span>
<span class="cm">/************************************************************************/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">JDEMDataset::Identify</span><span class="p">(</span><span class="w"> </span><span class="n">GDALOpenInfo</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">nHeaderBytes</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HEADER_SIZE</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Confirm that the header has what appears to be dates in the</span>
<span class="w">    </span><span class="c1">// expected locations.</span>
<span class="w">    </span><span class="c1">// Check if century values seem reasonable.</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">psHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pabyHeader</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">STARTS_WITH_CI</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;19&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="o">!</span><span class="n">STARTS_WITH_CI</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;20&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="o">!</span><span class="n">STARTS_WITH_CI</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;19&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="o">!</span><span class="n">STARTS_WITH_CI</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;20&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="o">!</span><span class="n">STARTS_WITH_CI</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;19&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="o">!</span><span class="n">STARTS_WITH_CI</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;20&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check the extent too. In particular, that we are in the first quadrant,</span>
<span class="w">    </span><span class="c1">// as this is only for Japan.</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfLLLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">29</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfLLLong</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">36</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfURLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">43</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfURLong</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">dfLLLat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dfLLLat</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">dfLLLong</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">180</span><span class="w"> </span><span class="o">||</span><span class="n">dfLLLong</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">dfURLat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dfURLat</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">dfURLong</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">180</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dfURLong</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">dfLLLat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dfURLat</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">dfLLLong</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dfURLong</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>可能な限り厳格な&quot;これは私のフォーマットですか&quot;テストを行うことが重要です.この特定の場合,日付が 19 世紀または 20 世紀であることをチェックしますが,これも弱すぎる可能性があるため,地理空間範囲が一貫しており,日本に適していることを確認し,ファイルが私たちのフォーマットであることを確認した後,ファイルが使用可能であることを検証するために必要な他のテストを実行し,特に望ましいアクセスレベルを提供できることを確認します. JDEM ドライバーは更新サポートを提供しないため,その場合はエラーが発生します.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">eAccess</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GA_Update</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_NotSupported</span><span class="p">,</span>
<span class="w">             </span><span class="s">&quot;The JDEM driver does not support update access to existing &quot;</span>
<span class="w">             </span><span class="s">&quot;datasets.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>次に,興味のあるさまざまな情報を設定するデータベースクラスのインスタンスを作成する必要があります. エラーコードパスでメモリ管理を容易にするために, std::unique_ptr&lt;JDEMDataset&gt; と cpl::make_unique&lt;&gt; ユーティリティ(C++14 以降で利用可能な std::make_unique&lt;&gt; に相当)で作成します.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Check that the file pointer from GDALOpenInfo* is available.</span>
<span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">fpL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span><span class="w"> </span><span class="n">poDS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpl</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">JDEMDataset</span><span class="o">&gt;</span><span class="p">();</span>

<span class="c1">// Borrow the file pointer from GDALOpenInfo*.</span>
<span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">m_fp</span><span class="p">,</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">fpL</span><span class="p">);</span>
</pre></div>
</div>
<p>この時点で, GDALOpenInfo* が保持していたファイルハンドルを&quot;借ります&quot;(インラインメンバ定義で poDS-&gt;m_fp が nullptr に初期化されていることを確認しました).このファイルポインタは,ディスク上のファイルにアクセスするための VSI*L GDAL API を使用します.この仮想化された POSIX スタイルの API には,大きなファイル,インメモリファイル,および圧縮ファイルをサポートするなどの特別な機能があります.</p>
<p>次に,ヘッダから X サイズと Y サイズを抽出します. <cite>nRasterXSize</cite> と <cite>nRasterYSize</cite> は,GDALDataset 基底クラスから継承されたデータフィールドであり,Open() メソッドで設定する必要があります.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Store the header (we have already checked it is at least HEADER_SIZE</span>
<span class="c1">// byte large).</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">m_abyHeader</span><span class="p">,</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pabyHeader</span><span class="p">,</span><span class="w"> </span><span class="n">HEADER_SIZE</span><span class="p">);</span>

<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">psHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">m_abyHeader</span><span class="p">);</span>
<span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetField</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetField</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">GDALCheckDatasetDimensions</span><span class="p">(</span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterXSize</span><span class="p">,</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">nRasterYSize</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>このデータセットに関連するすべてのバンドは,SetBand() メソッドを使用して作成およびアタッチする必要があります. JDEMRasterBand() クラスについてはすぐに調査します.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create band information objects.</span>
<span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetBand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JDEMRasterBand</span><span class="p">(</span><span class="n">poDS</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
</pre></div>
</div>
<p>最後に,データセットオブジェクトに名前を割り当て,利用可能な場合は .aux.xml ファイルから補助情報を初期化できる GDALPamDataset TryLoadXML() メソッドを呼び出します. また,外部の概要情報(.ovr サイドカーファイル)の初期化も行います. これらのサービスの詳細については,GDALPamDataset および関連クラスを参照してください.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Initialize any PAM information.</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetDescription</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pszFilename</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">TryLoadXML</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Check for overviews.</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">oOvManager</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">poDS</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pszFilename</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">poDS</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="implementing-the-rasterband">
<h2>ラスターバンドの実装<a class="headerlink" href="#implementing-the-rasterband" title="Link to this heading"></a></h2>
<p>GDALDataset からサブクラス化されたカスタマイズされた JDEMDataset クラスと同様に,JDEM ファイルのバンドにアクセスするための <a class="reference internal" href="../api/gdalrasterband_cpp.html#_CPPv414GDALRasterBand" title="GDALRasterBand"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GDALRasterBand</span></code></a> から派生したカスタマイズされた JDEMRasterBand を宣言および実装する必要があります. JDEMRasterBand の宣言は次のようになります:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JDEMRasterBand</span><span class="w"> </span><span class="k">final</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">GDALPamRasterBand</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">JDEMDataset</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w">          </span><span class="n">m_nRecordSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w">        </span><span class="o">*</span><span class="n">m_pszRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">         </span><span class="n">m_bBufferAllocFailed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span>
<span class="w">                </span><span class="n">JDEMRasterBand</span><span class="p">(</span><span class="w"> </span><span class="n">JDEMDataset</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">);</span>
<span class="w">               </span><span class="o">~</span><span class="n">JDEMRasterBand</span><span class="p">();</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">CPLErr</span><span class="w"> </span><span class="nf">IReadBlock</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>コンストラクタには任意のシグネチャを持たせることができ,Open() メソッドからのみ呼び出されます.その他の仮想メソッド,例えば <a class="reference internal" href="../api/gdalrasterband_cpp.html#_CPPv4N14GDALRasterBand10IReadBlockEiiPv" title="GDALRasterBand::IReadBlock"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALRasterBand::IReadBlock()</span></code></a> は,gdal_priv.h でのメソッドシグネチャと完全に一致している必要があります.</p>
<p>コンストラクタの実装は次のようになります:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">JDEMRasterBand</span><span class="o">::</span><span class="n">JDEMRasterBand</span><span class="p">(</span><span class="w"> </span><span class="n">JDEMDataset</span><span class="w"> </span><span class="o">*</span><span class="n">poDSIn</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nBandIn</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Cannot overflow as nBlockXSize &lt;= 999.</span>
<span class="w">    </span><span class="n">m_nRecordSize</span><span class="p">(</span><span class="n">poDSIn</span><span class="o">-&gt;</span><span class="n">GetRasterXSize</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">poDS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poDSIn</span><span class="p">;</span>
<span class="w">    </span><span class="n">nBand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nBandIn</span><span class="p">;</span>

<span class="w">    </span><span class="n">eDataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GDT_Float32</span><span class="p">;</span>

<span class="w">    </span><span class="n">nBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">GetRasterXSize</span><span class="p">();</span>
<span class="w">    </span><span class="n">nBlockYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下のデータメンバは GDALRasterBand から継承され,通常はバンドコンストラクタで設定する必要があります.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="nl">poDS</span><span class="p">:</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="n">GDALDataset</span><span class="p">.</span>
<span class="nl">nBand</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">band</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dataset</span><span class="p">.</span>
<span class="nl">eDataType</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">pixels</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">band</span><span class="p">.</span>
<span class="nl">nBlockXSize</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">band</span><span class="p">.</span>
<span class="nl">nBlockYSize</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">band</span><span class="p">.</span>
</pre></div>
</div>
<p>可能な GDALDataType 値の全セットは gdal.h で宣言されており,GDT_Byte,GDT_UInt16,GDT_Int16,および GDT_Float32 が含まれます. ブロックサイズは,データにアクセスするための自然または効率的なブロックサイズを確立するために使用されます. タイルデータセットの場合,これはタイルのサイズになりますが,ほとんどの他のデータセットの場合は,この場合のように1 スキャンラインになります.</p>
<p>次に,実際に画像データを読み取るコードの実装, IReadBlock() を見ます.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">CPLErr</span><span class="w"> </span><span class="nf">JDEMRasterBand::IReadBlock</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="cm">/* nBlockXOff */</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">int</span><span class="w"> </span><span class="n">nBlockYOff</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pImage</span><span class="w"> </span><span class="p">)</span>

<span class="p">{</span>
<span class="w">    </span><span class="n">JDEMDataset</span><span class="w"> </span><span class="o">*</span><span class="n">poGDS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpl</span><span class="o">::</span><span class="n">down_cast</span><span class="o">&lt;</span><span class="n">JDEMDataset</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">poDS</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pszRecord</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_bBufferAllocFailed</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CE_Failure</span><span class="p">;</span>

<span class="w">        </span><span class="n">m_pszRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">VSI_MALLOC_VERBOSE</span><span class="p">(</span><span class="n">m_nRecordSize</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pszRecord</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">m_bBufferAllocFailed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CE_Failure</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">CPL_IGNORE_RET_VAL</span><span class="p">(</span>
<span class="w">        </span><span class="n">VSIFSeekL</span><span class="p">(</span><span class="n">poGDS</span><span class="o">-&gt;</span><span class="n">m_fp</span><span class="p">,</span><span class="w"> </span><span class="mi">1011</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_nRecordSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nBlockYOff</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">VSIFReadL</span><span class="p">(</span><span class="n">m_pszRecord</span><span class="p">,</span><span class="w"> </span><span class="n">m_nRecordSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">poGDS</span><span class="o">-&gt;</span><span class="n">m_fp</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_AppDefined</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;Cannot read scanline %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nBlockYOff</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CE_Failure</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">EQUALN</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">poGDS</span><span class="o">-&gt;</span><span class="n">m_abyHeader</span><span class="p">),</span><span class="w"> </span><span class="n">m_pszRecord</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_AppDefined</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;JDEM Scanline corrupt.  Perhaps file was not transferred &quot;</span>
<span class="w">                 </span><span class="s">&quot;in binary mode?&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CE_Failure</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">JDEMGetField</span><span class="p">(</span><span class="n">m_pszRecord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nBlockYOff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_AppDefined</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;JDEM scanline out of order, JDEM driver does not &quot;</span>
<span class="w">                 </span><span class="s">&quot;currently support partial datasets.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CE_Failure</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nBlockXSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pImage</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">JDEMGetField</span><span class="p">(</span><span class="n">m_pszRecord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CE_None</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意すべき重要な項目は次のとおりです:</p>
<ul class="simple">
<li><p>GDALRasterBand::poDS メンバを所有するデータセットの派生型にキャストするのは一般的です.ラスターバンドクラスが所有するデータセットオブジェクトに特権的なアクセスが必要な場合,それが friend として宣言されていることを確認してください(簡潔さのために省略されています).</p></li>
<li><p>エラーが発生した場合は,CPLError() で報告し,CE_Failure を返します. それ以外の場合は,CE_None を返します.</p></li>
<li><p>pImage バッファには,1 ブロックのデータが格納されている必要があります. ブロックは,ラスターバンドの nBlockXSize および nBlockYSize で宣言されたサイズです. pImage 内のデータのタイプは,ラスターバンドオブジェクトの eDataType で宣言されたタイプと一致している必要があります.</p></li>
<li><p>nBlockXOff および nBlockYOff はブロックオフセットであり,128x128 タイルデータセットの場合,1 と 1 の値は,ブロックが (128,128) から (255,255) になることを示しています.</p></li>
</ul>
</section>
<section id="the-driver">
<h2>ドライバー<a class="headerlink" href="#the-driver" title="Link to this heading"></a></h2>
<p>JDEMDataset と JDEMRasterBand は,画像データを読み取るために使用する準備ができていますが,GDAL システムが新しいドライバーについてどのように知るかはまだ明確ではありません.これは <a class="reference internal" href="../api/gdaldriver_cpp.html#_CPPv417GDALDriverManager" title="GDALDriverManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GDALDriverManager</span></code></a> を介して実現されます. フォーマットを登録するために,登録関数を実装します. 宣言は gcore/gdal_frmts.h にあります: void CPL_DLL GDALRegister_JDEM(void);</p>
<p>ドライバーファイルの定義は次のようになります:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GDALRegister_JDEM</span><span class="p">()</span>

<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">GDAL_CHECK_VERSION</span><span class="p">(</span><span class="s">&quot;JDEM&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">GDALGetDriverByName</span><span class="p">(</span><span class="s">&quot;JDEM&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">GDALDriver</span><span class="w"> </span><span class="o">*</span><span class="n">poDriver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GDALDriver</span><span class="p">();</span>

<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetDescription</span><span class="p">(</span><span class="s">&quot;JDEM&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DCAP_RASTER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;YES&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DMD_LONGNAME</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Japanese DEM (.mem)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DMD_HELPTOPIC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;drivers/raster/jdem.html&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DMD_EXTENSIONS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mem&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">SetMetadataItem</span><span class="p">(</span><span class="n">GDAL_DCAP_VIRTUALIO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;YES&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">pfnOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMDataset</span><span class="o">::</span><span class="n">Open</span><span class="p">;</span>
<span class="w">    </span><span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">pfnIdentify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMDataset</span><span class="o">::</span><span class="n">Identify</span><span class="p">;</span>

<span class="w">    </span><span class="n">GetGDALDriverManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">RegisterDriver</span><span class="p">(</span><span class="n">poDriver</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>GDAL_CHECK_VERSION マクロの使用に注意してください. これは,プラグインとしてビルドできるドライバーで使用する必要があるマクロです. GDAL C++ ABI は,例えば GDAL 3.x.0 から 3.y.0 に変更される可能性があり,変更される必要があります. したがって,ヘッダーファイルのバージョンにしたがってGDALドライバーを再コンパイルする必要があります.GDAL_CHECK_VERSION マクロは,ドライバーがコンパイルされた GDAL バージョンと実行されているバージョンが互換性があるかどうかを確認します(メジャーバージョンとマイナーバージョンが等しいかどうかを確認します). ただし,同じリリースブランチのリリースでは C++ ABI は安定したままです(つまり,特定の機能リリース x.y.0 のバグ修正リリース x.y.z に対して).</p>
<p>登録関数は,最初に呼び出されたときに GDALDriver オブジェクトのインスタンスを作成し,GDALDriverManager に登録します. GDALDriverManager に登録する前に,次のフィールドをドライバーに設定できます.</p>
<ul class="simple">
<li><p>説明はフォーマットの短い名前です. これは,このフォーマットの一意の名前であり,スクリプトやコマンドラインプログラムでドライバーを識別するためによく使用されます. 通常,3-5 文字の長さで,フォーマットクラスのプレフィックスと一致します. (必須)</p></li>
<li><p>GDAL_DCAP_RASTER: このドライバーがラスターデータを処理することを示すために YES に設定します. (必須)</p></li>
<li><p>GDAL_DMD_LONGNAME: ファイルフォーマットのためのより詳細な説明的な名前ですが,50-60 文字を超えないようにします. (必須)</p></li>
<li><p>GDAL_DMD_HELPTOPIC: このドライバーに表示するヘルプトピックの名前です. この場合,JDEM フォーマットは,gdal/html に保持されているさまざまなフォーマットのウェブページに含まれています. (オプション)</p></li>
<li><p>GDAL_DMD_EXTENSIONS: このタイプのファイルに使用される拡張子です. 先頭の '.' は含まれません.複数ある場合は,スペースで区切る必要があります. (オプション)</p></li>
<li><p>GDAL_DMD_MIMETYPE: このファイルフォーマットの標準 MIME タイプ,例えば &quot;image/png&quot; です. (オプション)</p></li>
<li><p>GDAL_DMD_CREATIONOPTIONLIST: 作成オプションを記述するメカニズムに関する進化する作業があります.これについての例については,geotiff ドライバーを参照してください. (オプション)</p></li>
<li><p>GDAL_DMD_CREATIONDATATYPES: 新しいデータセットを作成するときにサポートされるスペースで区切られたデータタイプのリストです. Create() メソッドが存在する場合,これらはサポートされます. CreateCopy() メソッドが存在する場合,これは損失なくエクスポートできるタイプのリストですが,最終的に書き込まれるタイプよりも弱いデータタイプが含まれる可能性があります. たとえば,CreateCopy() メソッドを持つフォーマットで,常に Float32 を書き込む場合,Byte,Int16,および UInt16 をリストアップすることがあります. これは,Float32 に損失なく変換できるためです. 例の値は &quot;Byte Int16 UInt16&quot; です. (必須 - 作成がサポートされている場合)</p></li>
<li><p>GDAL_DCAP_VIRTUALIO: このドライバーが VSI*L GDAL API で開かれたファイルを処理できることを示すために,YES に設定します. それ以外の場合,このメタデータ項目は定義されていない必要があります. (オプション)</p></li>
<li><p>pfnOpen: このフォーマットのファイルを開こうとするために呼び出す関数です. (オプション)</p></li>
<li><p>pfnIdentify: このフォーマットのファイルを識別しようとするために呼び出す関数です.ドライバーは,ファイルを自分のフォーマットとして認識する場合は 1 を返し,ファイルを自分のフォーマットとして認識しない場合は 0 を返し,ヘッダバイトを調べるだけでは確定的な結論に達することができない場合は -1 を返します. (オプション)</p></li>
<li><p>pfnCreate: このフォーマットの新しい更新可能データセットを作成するために呼び出す関数です. (オプション)</p></li>
<li><p>pfnCreateCopy: 他のソースからコピーされたこのフォーマットの新しいデータセットを作成するために呼び出す関数ですが,必ずしも更新可能ではありません. (オプション)</p></li>
<li><p>pfnDelete: このフォーマットのデータセットを削除するために呼び出す関数です. (オプション)</p></li>
<li><p>pfnUnloadDriver: ドライバーが破棄されたときにのみ呼び出される関数です. ドライバーレベルでデータをクリーンアップするために使用できます.ほとんど使用されません. (オプション)</p></li>
</ul>
<p>プラグインとしてビルドできるドライバー(つまり,ランタイムで GDAL によってロードされるスタンドアロン共有オブジェクト)の場合,GDAL 3.9 以降と <a class="reference internal" href="../development/rfc/rfc96_deferred_plugin_loading.html#rfc-96"><span class="std std-ref">RFC 96: Deferred C++ plugin loading</span></a> 以降,ドライバーを実装する方法があります. この方法では,プラグインは必要なときにのみロードされ,すぐに <a class="reference internal" href="../api/raster_c_api.html#_CPPv415GDALAllRegisterv" title="GDALAllRegister"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALAllRegister()</span></code></a> 実行時にロードされません.遅延プラグインロードに互換性のあるドライバーにするために必要な変更については, <a class="reference internal" href="../development/rfc/rfc96_deferred_plugin_loading.html#rfc96-example-driver"><span class="std std-ref">Example of changes to do on a simplified driver</span></a> を参照してください.</p>
</section>
<section id="adding-driver-to-gdal-tree">
<h2>ドライバーを GDAL ツリーに追加<a class="headerlink" href="#adding-driver-to-gdal-tree" title="Link to this heading"></a></h2>
<p>JDEM ドライバーにアクセスするためには,上位レベルのプログラムで GDALRegister_JDEM() メソッドを呼び出す必要があります.新しいドライバーを書くときの通常の方法は次のとおりです:</p>
<ul class="simple">
<li><p>frmts の下にドライバーディレクトリを追加し,ディレクトリ名を短い名前と同じにします.</p></li>
<li><p>そのディレクトリに他の類似のディレクトリ(つまり jdem ディレクトリ)からモデルとなる CMakeLists.txt を追加します.</p></li>
<li><p>新しいドライバーを frmts/CMakeLists.txt で参照し,gdal_optional_format() または gdal_dependent_format() 関数を使用します.外部依存関係がない場合は gdal_optional_format() を使用し,少なくとも 1 つの依存関係がある場合は gdal_dependent_format() を使用します.</p></li>
<li><p>モジュールにデータセットとラスターバンドの実装を追加します. 一般的には &lt;short_name&gt;dataset.cpp と呼ばれ,GDAL 固有のコードが 1 つのファイルにすべて含まれていますが,これは必須ではありません.</p></li>
<li><p>登録エントリーポイント宣言(GDALRegister_JDEM()) を gcore/gdal_frmts.h に追加します.</p></li>
<li><p>適切な #ifdef で保護された frmts/gdalallregister.cpp に登録関数を追加します.</p></li>
</ul>
<p>これらのすべてが完了すると,GDAL を再構築し,新しいフォーマットをすべてのユーティリティで利用できるようにすることができます. <a class="reference internal" href="../programs/gdalinfo.html#gdalinfo"><span class="std std-ref">gdalinfo</span></a> ユーティリティを使用して,フォーマットの開くことと報告が機能しているかどうかをテストし, <a class="reference internal" href="../programs/gdal_translate.html#gdal-translate"><span class="std std-ref">gdal_translate</span></a> ユーティリティを使用して画像の読み取りをテストできます.</p>
</section>
<section id="adding-georeferencing">
<h2>ジオリファレンシングの追加<a class="headerlink" href="#adding-georeferencing" title="Link to this heading"></a></h2>
<p>次に,ジオリファレンシングサポートを追加して,例をさらに進めます. GDALDataset ベースクラスのメソッドのシグネチャと完全に一致するように,JDEMDataset に次の 2 つの仮想メソッドオーバーライドを追加します.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">CPLErr</span><span class="w"> </span><span class="nf">GetGeoTransform</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padfTransform</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">OGRSpatialReference</span><span class="o">*</span><span class="w"> </span><span class="nf">GetSpatialRef</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</pre></div>
</div>
<p>The implementation of <a class="reference internal" href="../api/gdaldataset_cpp.html#_CPPv4N11GDALDataset15GetGeoTransformEPd" title="GDALDataset::GetGeoTransform"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALDataset::GetGeoTransform()</span></code></a> just copies the usual geotransform matrix into the supplied buffer. Note that <a class="reference internal" href="../api/gdaldataset_cpp.html#_CPPv4N11GDALDataset15GetGeoTransformEPd" title="GDALDataset::GetGeoTransform"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALDataset::GetGeoTransform()</span></code></a> may be called a lot, so it isn't generally wise to do a lot of computation in it. In many cases the Open() will collect the geotransform, and this method will just copy it over. Also note that the geotransform return is based on an anchor point at the top left corner of the top left pixel, not the center of pixel approach used in some packages.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">CPLErr</span><span class="w"> </span><span class="nf">JDEMDataset::GetGeoTransform</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">padfTransform</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">psHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">m_abyHeader</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfLLLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">29</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfLLLong</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">36</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfURLat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">43</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dfURLong</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDEMGetAngle</span><span class="p">(</span><span class="n">psHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span>

<span class="w">    </span><span class="n">padfTransform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dfLLLong</span><span class="p">;</span>
<span class="w">    </span><span class="n">padfTransform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dfURLat</span><span class="p">;</span>
<span class="w">    </span><span class="n">padfTransform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dfURLong</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dfLLLong</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">GetRasterXSize</span><span class="p">();</span>
<span class="w">    </span><span class="n">padfTransform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">padfTransform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">padfTransform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">dfURLat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dfLLLat</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">GetRasterYSize</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CE_None</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../api/gdaldataset_cpp.html#_CPPv4NK11GDALDataset13GetSpatialRefEv" title="GDALDataset::GetSpatialRef"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALDataset::GetSpatialRef()</span></code></a> method returns a pointer to an internal OGRSpatialReference object.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">OGRSpatialReference</span><span class="w"> </span><span class="o">*</span><span class="nf">JDEMDataset::GetSpatialRef</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_oSRS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この場合,このフォーマットのすべてのファイルに対して座標系が固定されており, JDEMDataset コンストラクタで初期化されています.しかし,より複雑な場合には,定義を動的に構成する必要がある場合があります. その場合,定義を構築するのに <a class="reference internal" href="../api/ogrspatialref.html#_CPPv419OGRSpatialReference" title="OGRSpatialReference"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">OGRSpatialReference</span></code></a> クラスを使用すると便利です.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">JDEMDataset</span><span class="o">::</span><span class="n">JDEMDataset</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">m_abyHeader</span><span class="p">,</span><span class="w"> </span><span class="n">CPL_ARRAYSIZE</span><span class="p">(</span><span class="n">m_abyHeader</span><span class="p">),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GByte</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">m_oSRS</span><span class="p">.</span><span class="n">SetAxisMappingStrategy</span><span class="p">(</span><span class="n">OAMS_TRADITIONAL_GIS_ORDER</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_oSRS</span><span class="p">.</span><span class="n">importFromEPSG</span><span class="p">(</span><span class="mi">4301</span><span class="p">);</span><span class="w"> </span><span class="c1">// Tokyo geographic CRS</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これで,JDEM ドライバーの機能の説明が完了しました. 必要に応じて,jdemdataset.cpp の完全なソースを確認できます.</p>
</section>
<section id="overviews">
<h2>オーバービュー<a class="headerlink" href="#overviews" title="Link to this heading"></a></h2>
<p>GDAL は,ファイルフォーマットが事前に構築されたオーバービューをアプリケーションで利用可能にするために, <a class="reference internal" href="../api/gdalrasterband_cpp.html#_CPPv4N14GDALRasterBand11GetOverviewEi" title="GDALRasterBand::GetOverview"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALRasterBand::GetOverview()</span></code></a> および関連メソッドを使用することを許可しています. ただし,これを実装することはかなり複雑であり,現時点ではこのドキュメントの範囲を超えています. GeoTIFF ドライバー(gdal/frmts/gtiff/geotiff.cpp) および関連ソースは,オーバービューの報告と作成サポートを実装するファイルフォーマットの例を確認できます.</p>
<p>フォーマットは, <a class="reference internal" href="../api/gdalrasterband_cpp.html#_CPPv4N14GDALRasterBand21HasArbitraryOverviewsEv" title="GDALRasterBand::HasArbitraryOverviews"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALRasterBand::HasArbitraryOverviews()</span></code></a> メソッドをオーバーライドして,GDALRasterBand で TRUE を返すことで,任意のオーバービューを持っていることを報告することもできます.この場合,ラスターバンドオブジェクトは,効率的なイメージのリサンプリングアクセスを実装するために, <a class="reference internal" href="../api/gdalrasterband_cpp.html#_CPPv4N14GDALRasterBand8RasterIOE10GDALRWFlagiiiiPvii12GDALDataType8GSpacing8GSpacingP20GDALRasterIOExtraArg" title="GDALRasterBand::RasterIO"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALRasterBand::RasterIO()</span></code></a> メソッド自体をオーバーライドすることが期待されます. これも複雑であり,RasterIO() メソッドの正しい実装には多くの要件があります. これに関する例は,OGDI および ECW フォーマットで見つけることができます.</p>
<p>ただし,オーバービューを実装する最も一般的なアプローチは,データセットと同じ名前の TIFF ファイルに格納された外部オーバービューを使用することですが,拡張子 .ovr が追加されます. このスタイルのオーバービューの読み取りと作成を有効にするためには,GDALDataset が自身内部の <cite>oOvManager</cite> オブジェクトを初期化する必要があります. これは通常,Open() メソッドの最後の方(PAM <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALDataset::TryLoadXML()</span></code> の後)に次のような呼び出しで実行されます.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">oOvManager</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">poDS</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pszFilename</span><span class="p">);</span>
</pre></div>
</div>
<p>これにより,フォーマットのオーバービューの読み取りと作成のデフォルト実装が有効になります.カスタムオーバービューメカニズムが結び付けられる場合を除いて,すべてのシンプルなファイルシステムベースのフォーマットに対してこれを有効にすることが推奨されます.</p>
</section>
<section id="file-creation">
<h2>ファイルの作成<a class="headerlink" href="#file-creation" title="Link to this heading"></a></h2>
<p>ファイルの作成には 2 つのアプローチがあります. 最初の方法は, <a class="reference internal" href="../api/gdaldriver_cpp.html#_CPPv4N10GDALDriver10CreateCopyEPKcP11GDALDataseti12CSLConstList16GDALProgressFuncPv" title="GDALDriver::CreateCopy"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GDALDriver::CreateCopy()</span></code></a> メソッドと呼ばれ,出力フォーマットでファイルを書き込む関数を実装し,ソース GDALDataset から必要なすべてのイメージおよびその他の情報を取得します.2 番目の方法である動的作成方法は,ファイルのシェルを作成する Create メソッドを実装し,その後,アプリケーションがさまざまな情報を設定メソッドを呼び出して書き込むことを含みます.</p>
<p>最初の方法の利点は,出力ファイルが作成されている時点ですべての情報が利用可能であることです.ファイルが作成される時点でカラーマップやジオリファレンシング情報などの情報が必要な外部ライブラリを使用してファイルフォーマットを実装する場合に特に重要です. この方法のもう 1 つの利点は,CreateCopy() メソッドが,最小/最大値,スケーリング,説明および GCP など,設定メソッドが存在しないいくつかの情報を読み取ることができることです.</p>
<p>2 番目の方法の利点は,アプリケーションが空の新しいファイルを作成し,利用可能になるとすぐに結果を書き込むことができることです.望ましいデータの完全なイメージが事前に利用可能である必要はありません.</p>
<p>非常に重要なフォーマットの場合は,両方の方法を実装することができます. それ以外の場合は,より簡単な方法を選択するか,必要な機能を提供します.</p>
<section id="createcopy">
<h3>CreateCopy<a class="headerlink" href="#createcopy" title="Link to this heading"></a></h3>
<p>The GDALDriver::CreateCopy() method call is passed through directly, so that method should be consulted for details of arguments. However, some things to keep in mind are:</p>
<ul class="simple">
<li><p><cite>bStrict</cite> フラグが FALSE の場合,ドライバーは,ソースデータセットを正確に表現できない場合に,データ型を変換したり,ジオリファレンシングを削除したりするなど,何らかの合理的な処理を試みる必要があります.</p></li>
<li><p>進行状況の報告を正しく実装することは,かなり複雑です. 進行状況関数の戻り結果は常にキャンセルされているかどうかを確認する必要があり,進行状況は適切な間隔で報告する必要があります. JPEGCreateCopy() メソッドは,進行状況関数の適切な処理を示しています.</p></li>
<li><p>特別な作成オプションは,オンラインヘルプに記載する必要があります. オプションが &quot;NAME=VALUE&quot; 形式を取る場合,JPEGCreateCopy() の QUALITY および PROGRESSIVE フラグの処理で示されているように,papszOptions リストは <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CPLFetchNameValue()</span></code> を使用して操作できます.</p></li>
<li><p>返された GDALDataset ハンドルは,ReadOnly モードまたは Update モードである可能性があります. 実用的であれば,Update モードで返し,それ以外の場合は ReadOnly モードで問題ありません.</p></li>
</ul>
<p>JPEG の CreateCopy 関数の完全な実装(これは GDALDriver オブジェクトの pfnCreateCopy に割り当てられています)はここにあります. static GDALDataset *</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">JPEGCreateCopy</span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pszFilename</span><span class="p">,</span><span class="w"> </span><span class="n">GDALDataset</span><span class="w"> </span><span class="o">*</span><span class="n">poSrcDS</span><span class="p">,</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bStrict</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">papszOptions</span><span class="p">,</span>
<span class="w">                </span><span class="n">GDALProgressFunc</span><span class="w"> </span><span class="n">pfnProgress</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pProgressData</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nBands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poSrcDS</span><span class="o">-&gt;</span><span class="n">GetRasterCount</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poSrcDS</span><span class="o">-&gt;</span><span class="n">GetRasterXSize</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poSrcDS</span><span class="o">-&gt;</span><span class="n">GetRasterYSize</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Some some rudimentary checks</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">nBands</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nBands</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_NotSupported</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;JPEG driver doesn&#39;t support %d bands.  Must be 1 (grey) &quot;</span>
<span class="w">                </span><span class="s">&quot;or 3 (RGB) bands.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nBands</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poSrcDS</span><span class="o">-&gt;</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetRasterDataType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bStrict</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_NotSupported</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;JPEG driver doesn&#39;t support data type %s. &quot;</span>
<span class="w">                </span><span class="s">&quot;Only eight bit byte bands supported.&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">GDALGetDataTypeName</span><span class="p">(</span>
<span class="w">                    </span><span class="n">poSrcDS</span><span class="o">-&gt;</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetRasterDataType</span><span class="p">()));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// What options has the user selected?</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nQuality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">75</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">CSLFetchNameValue</span><span class="p">(</span><span class="n">papszOptions</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;QUALITY&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">nQuality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">CSLFetchNameValue</span><span class="p">(</span><span class="n">papszOptions</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;QUALITY&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">nQuality</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">nQuality</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_IllegalArg</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;QUALITY=%s is not a legal value in the range 10 - 100.&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">CSLFetchNameValue</span><span class="p">(</span><span class="n">papszOptions</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;QUALITY&quot;</span><span class="p">));</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bProgressive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">CSLFetchNameValue</span><span class="p">(</span><span class="n">papszOptions</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PROGRESSIVE&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">bProgressive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Create the dataset.</span>
<span class="w">    </span><span class="n">VSILFILE</span><span class="w"> </span><span class="o">*</span><span class="n">fpImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VSIFOpenL</span><span class="p">(</span><span class="n">pszFilename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wb&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">fpImage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_OpenFailed</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Unable to create jpeg file %s.&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">pszFilename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initialize JPG access to the file.</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">jpeg_compress_struct</span><span class="w"> </span><span class="n">sCInfo</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">jpeg_error_mgr</span><span class="w"> </span><span class="n">sJErr</span><span class="p">;</span>
<span class="w">    </span><span class="n">sCInfo</span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jpeg_std_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sJErr</span><span class="p">);</span>
<span class="w">    </span><span class="n">jpeg_create_compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">jpeg_stdio_dest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">,</span><span class="w"> </span><span class="n">fpImage</span><span class="p">);</span>
<span class="w">    </span><span class="n">sCInfo</span><span class="p">.</span><span class="n">image_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nXSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">sCInfo</span><span class="p">.</span><span class="n">image_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nYSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">sCInfo</span><span class="p">.</span><span class="n">input_components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nBands</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">nBands</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sCInfo</span><span class="p">.</span><span class="n">in_color_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JCS_GRAYSCALE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sCInfo</span><span class="p">.</span><span class="n">in_color_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JCS_RGB</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">jpeg_set_defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">jpeg_set_quality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">,</span><span class="w"> </span><span class="n">nQuality</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">bProgressive</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="n">jpeg_simple_progression</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">jpeg_start_compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Loop over image, copying image data.</span>
<span class="w">    </span><span class="n">GByte</span><span class="w"> </span><span class="o">*</span><span class="n">pabyScanline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GByte</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">CPLMalloc</span><span class="p">(</span><span class="n">nBands</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nXSize</span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iLine</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nYSize</span><span class="p">;</span><span class="w"> </span><span class="n">iLine</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iBand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iBand</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nBands</span><span class="p">;</span><span class="w"> </span><span class="n">iBand</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">GDALRasterBand</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">poBand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poSrcDS</span><span class="o">-&gt;</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">iBand</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">CPLErr</span><span class="w"> </span><span class="n">eErr</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">RasterIO</span><span class="p">(</span><span class="n">GF_Read</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iLine</span><span class="p">,</span><span class="w"> </span><span class="n">nXSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                </span><span class="n">pabyScanline</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">iBand</span><span class="p">,</span><span class="w"> </span><span class="n">nXSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="p">,</span>
<span class="w">                                </span><span class="n">nBands</span><span class="p">,</span><span class="w"> </span><span class="n">nBands</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nXSize</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// TODO: Handle error.</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">JSAMPLE</span><span class="w"> </span><span class="o">*</span><span class="n">ppSamples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pabyScanline</span><span class="p">;</span>
<span class="w">        </span><span class="n">jpeg_write_scanlines</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ppSamples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">CPLFree</span><span class="p">(</span><span class="n">pabyScanline</span><span class="p">);</span>
<span class="w">    </span><span class="n">jpeg_finish_compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">jpeg_destroy_compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCInfo</span><span class="p">);</span>
<span class="w">    </span><span class="n">VSIFCloseL</span><span class="p">(</span><span class="n">fpImage</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GDALDataset</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">GDALOpen</span><span class="p">(</span><span class="n">pszFilename</span><span class="p">,</span><span class="w"> </span><span class="n">GA_ReadOnly</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="dynamic-creation">
<h3>動的作成<a class="headerlink" href="#dynamic-creation" title="Link to this heading"></a></h3>
<p>動的作成の場合,ソースデータセットはありません. 代わりに,希望するファイルのサイズ,バンド数,およびピクセルデータ型が提供されますが,他の情報(ジオリファレンシングやイメージデータなど)は,後で生成された GDALDataset に対する他のメソッド呼び出しで提供されます.</p>
<p>次のサンプルは,PCI .aux ラベル付きの raw ラスター作成を実装しています. これは,非 GDAL 呼び出しを使用して空のがありますが,有効なファイルを作成し,最後に GDALOpen(,GA_Update) を呼び出して書き込み可能なファイルハンドルを返す一般的なアプローチに従っています.これにより,Open() 関数でさまざまな設定アクションを複製する必要がなくなります.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">GDALDataset</span><span class="w"> </span><span class="o">*</span><span class="nf">PAuxDataset::Create</span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pszFilename</span><span class="p">,</span>
<span class="w">                                </span><span class="kt">int</span><span class="w"> </span><span class="n">nXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nYSize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nBands</span><span class="p">,</span>
<span class="w">                                </span><span class="n">GDALDataType</span><span class="w"> </span><span class="n">eType</span><span class="p">,</span>
<span class="w">                                </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="cm">/* papszParamList */</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Verify input options.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">eType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GDT_Float32</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">eType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GDT_UInt16</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">eType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GDT_Int16</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span>
<span class="w">            </span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_AppDefined</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;Attempt to create PCI .Aux labeled dataset with an illegal &quot;</span>
<span class="w">            </span><span class="s">&quot;data type (%s).&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">GDALGetDataTypeName</span><span class="p">(</span><span class="n">eType</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Try to create the file.</span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VSIFOpen</span><span class="p">(</span><span class="n">pszFilename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_OpenFailed</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Attempt to create file `%s&#39; failed.&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">pszFilename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Just write out a couple of bytes to establish the binary</span>
<span class="w">    </span><span class="c1">// file, and then close it.</span>
<span class="w">    </span><span class="n">VSIFWrite</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\0\0</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">);</span>
<span class="w">    </span><span class="n">VSIFClose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create the aux filename.</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pszAuxFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">CPLMalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">pszFilename</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">));</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">pszAuxFilename</span><span class="p">,</span><span class="w"> </span><span class="n">pszFilename</span><span class="p">);;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">pszAuxFilename</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">pszAuxFilename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">pszAuxFilename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">strcat</span><span class="p">(</span><span class="n">pszAuxFilename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.aux&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Open the file.</span>
<span class="w">    </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VSIFOpen</span><span class="p">(</span><span class="n">pszAuxFilename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wt&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CPLError</span><span class="p">(</span><span class="n">CE_Failure</span><span class="p">,</span><span class="w"> </span><span class="n">CPLE_OpenFailed</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Attempt to create file `%s&#39; failed.&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">pszAuxFilename</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// We need to write out the original filename but without any</span>
<span class="w">    </span><span class="c1">// path components in the AuxiliaryTarget line.  Do so now.</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">pszFilename</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">iStart</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pszFilename</span><span class="p">[</span><span class="n">iStart</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">pszFilename</span><span class="p">[</span><span class="n">iStart</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="n">iStart</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="n">VSIFPrintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AuxilaryTarget: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pszFilename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">iStart</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Write out the raw definition for the dataset as a whole.</span>
<span class="w">    </span><span class="n">VSIFPrintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RawDefinition: %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">nXSize</span><span class="p">,</span><span class="w"> </span><span class="n">nYSize</span><span class="p">,</span><span class="w"> </span><span class="n">nBands</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Write out a definition for each band.  We always write band</span>
<span class="w">    </span><span class="c1">// sequential files for now as these are pretty efficiently</span>
<span class="w">    </span><span class="c1">// handled by GDAL.</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nImgOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iBand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iBand</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nBands</span><span class="p">;</span><span class="w"> </span><span class="n">iBand</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nPixelOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GDALGetDataTypeSize</span><span class="p">(</span><span class="n">eType</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nLineOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nPixelOffset</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pszTypeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GDT_Float32</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="n">pszTypeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;32R&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GDT_Int16</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="n">pszTypeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;16S&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GDT_UInt16</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="n">pszTypeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;16U&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">pszTypeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;8U&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">VSIFPrintf</span><span class="p">(</span><span class="w"> </span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ChanDefinition-%d: %s %d %d %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">iBand</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pszTypeName</span><span class="p">,</span>
<span class="w">                    </span><span class="n">nImgOffset</span><span class="p">,</span><span class="w"> </span><span class="n">nPixelOffset</span><span class="p">,</span><span class="w"> </span><span class="n">nLineOffset</span><span class="p">,</span>
<span class="cp">#ifdef CPL_LSB</span>
<span class="w">                    </span><span class="s">&quot;Swapped&quot;</span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="s">&quot;Unswapped&quot;</span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">        </span><span class="n">nImgOffset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nLineOffset</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cleanup.</span>
<span class="w">    </span><span class="n">VSIFClose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">GDALDataset</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">GDALOpen</span><span class="p">(</span><span class="n">pszFilename</span><span class="p">,</span><span class="w"> </span><span class="n">GA_Update</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>動的作成をサポートするファイルフォーマット,または単に更新インプレースアクセスをサポートするファイルフォーマットは,ラスターバンドクラスに IWriteBlock() メソッドを実装する必要があります. これは, IReadBlock() に類似したセマンティクスを持ちます.さらに,さまざまな難解な理由から,ラスターバンドデストラクタに FlushCache() メソッドを実装することが重要です.これは,デストラクタが呼び出される前にバンドの書き込みキャッシュブロックがフラッシュされることを保証するためです.</p>
</section>
</section>
<section id="rawdataset-rawrasterband-helper-classes">
<h2>RawDataset/RawRasterBand ヘルパークラス<a class="headerlink" href="#rawdataset-rawrasterband-helper-classes" title="Link to this heading"></a></h2>
<p>多くのファイルフォーマットは,実際のイメージデータが通常のバイナリ形式でスキャンライン指向の形式で格納されています.各フォーマットに対してこれを再実装する代わりに,効率的かつ便利なアクセスを実装するために,gcore/ で宣言された <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RawDataset</span></code> および <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RawRasterBand</span></code> クラスが提供されています.</p>
<p>この場合,フォーマット固有のバンドクラスが必要ない場合があります. または,必要な場合は RawRasterBand から派生させることができます.データセットクラスは RawDataset から派生させる必要があります.</p>
<p>データセットの Open() メソッドは,そのレイアウト情報をコンストラクタに渡してラスターバンドをインスタンス化します.たとえば,PNM ドライバーは,次の呼び出しを使用してラスターバンドを作成します.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">poOpenInfo</span><span class="o">-&gt;</span><span class="n">pabyHeader</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;5&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetBand</span><span class="p">(</span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RawRasterBand</span><span class="p">(</span><span class="n">poDS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">fpImage</span><span class="p">,</span>
<span class="w">                            </span><span class="n">iIn</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nWidth</span><span class="p">,</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetBand</span><span class="p">(</span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RawRasterBand</span><span class="p">(</span><span class="n">poDS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">fpImage</span><span class="p">,</span>
<span class="w">                            </span><span class="n">iIn</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">nWidth</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">));</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetBand</span><span class="p">(</span>
<span class="w">        </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RawRasterBand</span><span class="p">(</span><span class="n">poDS</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">fpImage</span><span class="p">,</span>
<span class="w">                            </span><span class="n">iIn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">nWidth</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">));</span>
<span class="w">    </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">SetBand</span><span class="p">(</span>
<span class="w">        </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RawRasterBand</span><span class="p">(</span><span class="n">poDS</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">poDS</span><span class="o">-&gt;</span><span class="n">fpImage</span><span class="p">,</span>
<span class="w">                            </span><span class="n">iIn</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">nWidth</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">GDT_Byte</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>RawRasterBand は,次の引数を取ります.</p>
<ul class="simple">
<li><p>poDS: このバンドが子になる GDALDataset. このデータセットは RawRasterDataset から派生したクラスである必要があります.</p></li>
<li><p>nBand: そのデータセットのバンド,1 から始まる.</p></li>
<li><p>fpRaw: ラスターデータを含むファイルへの FILE * ハンドル.</p></li>
<li><p>nImgOffset: 最初のスキャンラインのラスタデータの最初のピクセルまでのバイトオフセット.</p></li>
<li><p>nPixelOffset: 1 つのピクセルの開始から次のスキャンライン内の開始までのバイトオフセット.</p></li>
<li><p>nLineOffset: 1 つのスキャンラインの開始から次の開始までのバイトオフセット.</p></li>
<li><p>eDataType: ディスク上のデータのタイプのための GDALDataType コード.</p></li>
<li><p>bNativeOrder: データが GDAL が実行されているマシンと同じエンディアンでない場合は FALSE. データは自動的にバイトスワップされます.</p></li>
</ul>
<p>Raw サービスを利用するシンプルなファイルフォーマットは,通常,gdal/frmts/raw ディレクトリ内の 1 つのファイルに配置されます.そこには,フォーマットの実装の多くの例があります.</p>
</section>
<section id="metadata-and-other-exotic-extensions">
<h2>メタデータおよびその他のエキゾチックな拡張<a class="headerlink" href="#metadata-and-other-exotic-extensions" title="Link to this heading"></a></h2>
<p>GDAL データモデルには, GDALDataset および GDALRasterBand に仮想メソッドが存在するさまざまな項目があります.これには次のものが含まれます:</p>
<ul class="simple">
<li><p>メタデータ: データセットまたはバンドに関する名前/値テキスト値. GDALMajorObject (GDALRasterBand および GDALDataset の基本クラス) は,メタデータを保持するための組み込みサポートを持っているため,読み取りアクセスの場合は,Open() で SetMetadataItem() を呼び出すだけでよいです. SAR_CEOS (frmts/ceos2/sar_ceosdataset.cpp) および GeoTIFF ドライバーは,読み取り可能なメタデータを実装しているドライバーの例です.</p></li>
<li><p>カラーテーブル: GDT_Byte ラスターバンドには,それに関連付けられたカラーテーブルが存在することができます.frmts/png/pngdataset.cpp ドライバーには,カラーテーブルをサポートするフォーマットの例が含まれています.</p></li>
<li><p>ColorInterpretation: PNG ドライバーには,バンドを赤,緑,青,アルファまたはグレースケールバンドとして扱うかどうかを示すドライバーの例が含まれています.</p></li>
<li><p>GCPs: GDALDatasets には,ラスターをジオリファレンス座標に関連付けるための一連の地上制御点が関連付けられている場合があります(GetGeotransform() によって返される明示的なアフィン変換とは異なります). MFF2 (gdal/frmts/raw/hkvdataset.cpp) フォーマットは,GCPs をサポートするフォーマットの単純な例です.</p></li>
<li><p>NoDataValue: 既知の &quot;nodata&quot; 値を持つバンドは,GetNoDataValue() メソッドを実装することができます.これに関する例については,PAux (frmts/raw/pauxdataset.cpp) を参照してください.</p></li>
<li><p>カテゴリ名: 各クラスに名前を付けた分類画像は,GetCategoryNames() メソッドを使用してそれらを返すことができます.ただし,現在のところ,このメソッドを実装しているフォーマットはありません.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="warp_tut.html" class="btn btn-neutral float-right" title="GDAL Warp API tutorial (Reprojection, ...)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="raster_api_tut.html" class="btn btn-neutral float-left" title="ラスターAPIチュートリアル" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <div class="info">
      <a class="logo-link" href="https://osgeo.org">
        <div class="osgeo-logo"></div>
      </a>
      <div class="copyright">
      

      &copy; 1998-2024 <a href="https://github.com/warmerdam">Frank Warmerdam</a>,
      <a href="https://github.com/rouault">Even Rouault</a>, and
      <a href="https://github.com/OSGeo/gdal/graphs/contributors">others</a>


      
      </div>
    </div>
  </div>
</footer>
        </div>
      </div>
    </section>
  </div>
  
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>